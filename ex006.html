<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cadastro Full Stack</title>
<style>
:root { --primary:#6DC3BB; --secondary:#393D7E; --accent:#5459AC; --highlight:#F2AEBB; }
body { font-family: Arial,sans-serif; background:linear-gradient(135deg,var(--primary),var(--highlight)); padding:20px; }
.container { background:white; padding:25px; border-radius:10px; box-shadow:0 8px 20px rgba(0,0,0,0.15); }
input, button { padding:8px; margin:5px 0; border-radius:5px; border:1px solid #ccc; }
button { background:var(--secondary); color:white; border:none; cursor:pointer; }
button:hover { background:var(--accent); }
.btn-excluir { background:#F44336; }
.btn-excluir:hover { background:#d32f2f; }
table { width:100%; border-collapse:collapse; margin-top:20px; }
th, td { border:1px solid #ddd; padding:8px; text-align:center; }
th { background:var(--secondary); color:white; }
</style>
</head>
<body>
<div class="container">
<h2>Cadastro Full Stack</h2>

<div>
<input type="text" id="nome" placeholder="Nome">
<input type="email" id="email" placeholder="E-mail">
<input type="text" id="documento" placeholder="CPF/CNPJ">
<input type="text" id="motivo" placeholder="Motivo">
<input type="text" id="submotivo" placeholder="Sub-Motivo">
<input type="date" id="data">
<input type="text" id="protocolo" placeholder="Protocolo">
<button onclick="salvarRegistro()">Salvar</button>
</div>

<div style="margin-top:20px;">
<input type="text" id="busca" placeholder="Buscar por Nome, CPF ou Protocolo">
<button onclick="buscarRegistro()">Buscar</button>
<button onclick="listarRegistros()">Listar Todos</button>
</div>

<table id="tabela">
<thead>
<tr>
<th>Nome</th>
<th>E-mail</th>
<th>CPF/CNPJ</th>
<th>Motivo</th>
<th>Sub-Motivo</th>
<th>Data</th>
<th>Protocolo</th>
<th>Ações</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<script>
const API_URL = 'http://localhost:3000/clientes';
let registros = JSON.parse(localStorage.getItem('registros')) || [];

function salvarLocalStorage() {
    localStorage.setItem('registros', JSON.stringify(registros));
}

function renderizarTabela(lista) {
    const tbody = document.querySelector('#tabela tbody');
    tbody.innerHTML = '';

    lista.forEach((r, index) => {
        const linha = tbody.insertRow();
        linha.insertCell().textContent = r.nome;
        linha.insertCell().textContent = r.email;
        linha.insertCell().textContent = r.documento;
        linha.insertCell().textContent = r.motivo;
        linha.insertCell().textContent = r.submotivo;
        linha.insertCell().textContent = r.data;
        linha.insertCell().textContent = r.protocolo;

        const celulaAcoes = linha.insertCell();
        const btnExcluir = document.createElement('button');
        btnExcluir.textContent = 'Excluir';
        btnExcluir.className = 'btn-excluir';
        btnExcluir.onclick = () => excluirRegistro(r.protocolo);
        celulaAcoes.appendChild(btnExcluir);
    });
}

async function salvarRegistro() {
    const registro = {
        nome: document.getElementById('nome').value,
        email: document.getElementById('email').value,
        documento: document.getElementById('documento').value,
        motivo: document.getElementById('motivo').value,
        submotivo: document.getElementById('submotivo').value,
        data: document.getElementById('data').value,
        protocolo: document.getElementById('protocolo').value
    };

    if (!registro.protocolo) {
        alert('Informe um protocolo.');
        return;
    }

    registros.push(registro);
    salvarLocalStorage();
    renderizarTabela(registros);

    try {
        await fetch(API_URL, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(registro)
        });
    } catch(e) {
        console.warn('Backend indisponível, salvo apenas localmente.');
    }

    alert('Cadastro salvo com sucesso!');
}

async function excluirRegistro(protocolo) {
    if(!confirm('Deseja realmente excluir este cadastro?')) return;

    registros = registros.filter(r => r.protocolo !== protocolo);
    salvarLocalStorage();
    renderizarTabela(registros);

    try {
        await fetch(`${API_URL}/${protocolo}`, { method:'DELETE' });
    } catch(e) {
        console.warn('Não foi possível excluir no backend.');
    }
}

function buscarRegistro() {
    const termo = document.getElementById('busca').value.toLowerCase();
    const filtrados = registros.filter(r =>
        r.nome.toLowerCase().includes(termo) ||
        r.documento.includes(termo) ||
        r.protocolo.toLowerCase().includes(termo)
    );
    renderizarTabela(filtrados);
}

function listarRegistros() {
    renderizarTabela(registros);
}

renderizarTabela(registros);
</script>
</body>
</html>
